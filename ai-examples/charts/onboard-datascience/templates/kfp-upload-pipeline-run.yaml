
{{- if .Values.pipeline.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: job-pipelinerun-upload-{{ .Values.pipeline.name }}
  namespace: {{ $.Values.project.name }}
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  template:
    spec:
      containers:
      - name: kubectl
        image: bitnami/kubectl:latest
        command:
          - sh
          - -c
          - |
            if ! kubectl get pipelinerun -n my-namespace; then
                cat <<EOF | kubectl apply -f -
                apiVersion: tekton.dev/v1
                kind: PipelineRun
                metadata:
                    generateName: pipelinerun-upload-{{ .Values.pipeline.name }}
                    namespace: {{ $.Values.project.name }}
                spec:
                    pipelineRef:
                        name: pipeline-upload-{{ .Values.pipeline.name }}
                    workspaces:
                        - name: workspace-source
                        persistentVolumeClaim:
                            claimName: pipeline-upload-{{ .Values.pipeline.name }}-source-pvc
                EOF
            fi
      restartPolicy: Never
  backoffLimit: 1
{{- end }}

